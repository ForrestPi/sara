language: cpp

sudo: required
dist: trusty

cache:
  bundler: true
  directories:
  - $HOME/ffmpeg

addons:
  coverity_scan:
    project:
      name: "DO-CV/sara"
      description: "Build submitted via Travis CI"
    notification_email: "david.ok8@gmail.com"
    build_command_prepend: mkdir build-coverity && cd build-coverity && cmake -DCMAKE_BUILD_TYPE=Release ..
    build_command: make
    branch_pattern: coverity_scan
  apt:
    sources:
    - ubuntu-sdk-team
    - ubuntu-toolchain-r-test
    packages:
    - qtbase5-dev
    - lcov
    - libqt5opengl5
    - libqt5opengl5-dev
    - yasm

compiler:
  - gcc
  - clang

before_script:
  # Fake X server
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start

install:
  # Build and install third-party locally.
  - ./scripts/travis-build-and-install-third-party.sh
  - bundle install

script:
  # Build libraries.
  - mkdir build
  - cd build
  - cmake -DCMAKE_BUILD_TYPE=Debug -DSARA_BUILD_TESTS=ON -DSARA_BUILD_SAMPLES=ON -DSARA_BUILD_VIDEOIO=ON -DSARA_FFMPEG_DIR=$HOME/ffmpeg ..
  - make -j4
  # Run tests.
  - ctest --output-on-failure
  # Make package.
  - make package

after_success:
  - cd ..
  - lcov --compat-libtool --directory build --base-directory=cpp/src --capture --output-file=coverage.info
  - lcov --remove coverage.info 'usr/*' --output-file coverage.info
  - lcov --remove coverage.info 'cpp/third-party/*' --output-file coverage.info
  - lcov --remove coverage.info 'cpp/test/*' --output-file coverage.info
  - lcov --remove coverage.info 'build/moc_*' --output-file coverage.info
  - coveralls-lcov coverage.info
